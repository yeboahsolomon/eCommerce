// =================================================================
// GHANA MARKET - DATABASE SCHEMA
// =================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =================================================================
// IDENTITY (Who is acting?)
// =================================================================

enum Role {
  BUYER // Regular customer
  SELLER // Can list products
  ADMIN // Full system access
}

enum AccountStatus {
  ACTIVE
  SUSPENDED
  DEACTIVATED // Soft delete - preserves order history
}

enum SellerApplicationStatus {
  PENDING
  APPROVED
  REJECTED
  INFO_REQUESTED
}

enum BusinessType {
  INDIVIDUAL
  BUSINESS
}

enum MobileMoneyProvider {
  MTN
  TELECEL
  AIRTELTIGO
}

model User {
  id            String        @id @default(cuid())
  email         String        @unique
  password      String // bcrypt hashed
  phone         String? // Crucial for MoMo payments
  firstName     String
  lastName      String
  role          Role          @default(BUYER)
  status        AccountStatus @default(ACTIVE)
  emailVerified Boolean       @default(false)
  phoneVerified Boolean       @default(false)

  // Profile
  avatarUrl String?

  // Relations
  addresses     Address[]
  cart          Cart?
  orders        Order[]
  reviews       Review[]
  wishlist      Wishlist?
  sellerProfile SellerProfile?
  refreshTokens          RefreshToken[]
  emailVerificationTokens EmailVerificationToken[]
  passwordResetTokens     PasswordResetToken[]
  sellerApplications      SellerApplication[]

  // Timestamps
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  lastLoginAt  DateTime?
  SellerReview SellerReview[]

  @@index([email])
  @@index([phone])
  @@index([status])
}

model RefreshToken {
  id        String   @id @default(cuid())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String

  token     String   @unique // Hashed token
  expiresAt DateTime
  revoked   Boolean  @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([userId])
  @@index([token])
}

model EmailVerificationToken {
  id        String   @id @default(cuid())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String

  token     String   @unique // SHA-256 hash of the actual token
  expiresAt DateTime

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([token])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String

  token     String   @unique // SHA-256 hash
  expiresAt DateTime
  used      Boolean  @default(false)

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([token])
}

// =================================================================
// SELLER APPLICATION (Onboarding Flow)
// =================================================================

model SellerApplication {
  id     String @id @default(cuid())
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  // Application Status
  status SellerApplicationStatus @default(PENDING)

  // Business Information
  storeName       String
  businessType    BusinessType @default(INDIVIDUAL)
  businessEmail   String
  businessPhone   String
  businessAddress String
  ghanaRegion     String

  // Ghana Card Verification
  ghanaCardNumber   String
  ghanaCardImageUrl String?

  // Business Registration (required for BUSINESS type)
  businessRegImageUrl String?

  // Mobile Money Details
  mobileMoneyNumber   String
  mobileMoneyProvider MobileMoneyProvider

  // Admin Review
  rejectionReason String?
  adminNotes      String?
  reviewedBy      String?   // Admin user ID
  reviewedAt      DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

enum AddressType {
  HOME
  WORK
  OTHER
}

model Address {
  id     String @id @default(cuid())
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  // Address Details
  label    String // "Home", "Work", "Office"
  type     AddressType @default(HOME)
  fullName String // Recipient name
  phone    String // Delivery contact

  // Location (Ghana-specific)
  region        String // Greater Accra, Ashanti, etc.
  city          String
  area          String? // Neighborhood/suburb
  streetAddress String // Street name, house number, landmarks
  gpsAddress    String? // GhanaPost GPS (e.g., GA-183-8164)

  // Flags
  isDefault Boolean @default(false)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([isDefault])
}

// For SELLER role users
model SellerProfile {
  id     String @id @default(cuid())
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String @unique

  // Business Info
  businessName  String
  slug          String  @unique // For shop URL: /shop/my-store
  businessPhone String
  businessEmail String?
  description   String?
  logoUrl       String?
  bannerUrl     String?
  businessAddress String?
  ghanaRegion     String?

  // Verification & Legal
  isVerified   Boolean   @default(false)
  verifiedAt   DateTime?
  taxId        String?
  idCardType   String? // Ghana Card, Passport
  idCardNumber String?
  idCardImage  String?

  // Financials
  wallet  SellerWallet?
  payouts Payout[]

  // Relations
  products     Product[]
  sellerOrders SellerOrder[]
  reviews      SellerReview[]
  coupons      Coupon[]

  // Social & Contact
  website   String?
  instagram String?
  facebook  String?
  twitter   String?

  // System
  commissionRate Decimal @default(5.0) @db.Decimal(5, 2) // Platform fee %
  isActive       Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive])
  @@index([isVerified])
}

// =================================================================
// SELLER FINANCIALS
// =================================================================

model SellerWallet {
  id       String        @id @default(cuid())
  seller   SellerProfile @relation(fields: [sellerId], references: [id], onDelete: Cascade)
  sellerId String        @unique

  // Balances (in Pesewas)
  currentBalance Int @default(0) // Available for withdrawal
  pendingBalance Int @default(0) // Held until order completion
  totalEarned    Int @default(0) // Lifetime earnings
  totalWithdrawn Int @default(0)

  transactions Transaction[]

  updatedAt DateTime @updatedAt
}

enum TransactionType {
  SALE // + Credit from order
  REFUND // - Debit for refund
  PAYOUT // - Debit for withdrawal
  COMMISSION // - Debit platform fee
  ADJUSTMENT // +/- Admin adjustment
}

model Transaction {
  id       String       @id @default(cuid())
  wallet   SellerWallet @relation(fields: [walletId], references: [id], onDelete: Cascade)
  walletId String

  type          TransactionType
  amount        Int // Pesewas (positive or negative)
  balanceBefore Int
  balanceAfter  Int

  description String?
  referenceId String? // Linking to Order ID or Payout ID

  createdAt DateTime @default(now())

  @@index([walletId])
  @@index([type])
}

enum PayoutStatus {
  PENDING
  PROCESSING
  PAID
  FAILED
  CANCELLED
}

model Payout {
  id       String        @id @default(cuid())
  seller   SellerProfile @relation(fields: [sellerId], references: [id])
  sellerId String

  amount Int // Pesewas
  status PayoutStatus @default(PENDING)

  // Bank/MoMo Details snapshot
  destinationType    String // "MOMO", "BANK"
  destinationNumber  String? // MoMo number or Account number
  destinationNetwork String? // MTN, Voda, or Bank Name
  destinationName    String? // Account Holder Name

  // Transaction Info
  transactionReference String? // External ID (Paystack transfer code)
  processedAt          DateTime?

  notes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([sellerId])
  @@index([status])
}

model SellerReview {
  id       String        @id @default(cuid())
  seller   SellerProfile @relation(fields: [sellerId], references: [id], onDelete: Cascade)
  sellerId String
  user     User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId   String

  rating  Int
  comment String?

  createdAt DateTime @default(now())

  @@index([sellerId])
}

// =================================================================
// CATALOG (What are we selling?)
// =================================================================

model Category {
  id          String  @id @default(cuid())
  name        String  @unique
  slug        String  @unique
  description String?
  image       String?

  // Hierarchical Categories (Electronics -> Phones -> Samsung)
  parentId String?
  parent   Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children Category[] @relation("CategoryHierarchy")

  // Metadata
  sortOrder Int     @default(0)
  isActive  Boolean @default(true)

  // Relations
  products Product[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([parentId])
  @@index([slug])
  @@index([isActive])
}

model Product {
  id          String  @id @default(cuid())
  name        String
  slug        String  @unique
  description String?

  // PRICING - Using Int (Pesewas) to avoid floating point issues
  // Store in pesewas: â‚µ10.99 = 1099 pesewas
  priceInPesewas        Int
  comparePriceInPesewas Int? // Original/compare-at price for discounts
  costInPesewas         Int? // Cost price (for profit calculation)

  // INVENTORY - With concurrency handling
  stockQuantity     Int     @default(0)
  lowStockThreshold Int     @default(5)
  trackInventory    Boolean @default(true)
  allowBackorder    Boolean @default(false)

  // SKU & Identification
  sku     String? @unique
  barcode String?

  // Media
  images ProductImage[]

  // Categorization
  category   Category @relation(fields: [categoryId], references: [id])
  categoryId String

  // Seller (for marketplace)
  seller   SellerProfile? @relation(fields: [sellerId], references: [id])
  sellerId String?

  // SEO & Display
  metaTitle       String?
  metaDescription String?

  // Status
  isActive   Boolean @default(true)
  isFeatured Boolean @default(false)

  // Ratings (denormalized for performance)
  averageRating Decimal @default(0) @db.Decimal(2, 1)
  reviewCount   Int     @default(0)

  // Physical properties (for shipping)
  weightInGrams Int?

  // Relations
  cartItems     CartItem[]
  orderItems    OrderItem[]
  reviews       Review[]
  wishlistItems WishlistItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([categoryId])
  @@index([sellerId])
  @@index([isActive])
  @@index([isFeatured])
  @@index([slug])
  @@index([sku])
}

model ProductImage {
  id        String  @id @default(cuid())
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId String

  url       String
  storageKey String? @unique // Nullable for existing local images
  altText   String?
  fileSize  Int?
  mimeType  String?
  sortOrder Int     @default(0)
  isPrimary Boolean @default(false)

  createdAt DateTime @default(now())

  @@index([productId])
}

model Review {
  id        String  @id @default(cuid())
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId String
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String

  rating  Int // 1-5
  title   String?
  comment String?

  isVerifiedPurchase Boolean @default(false)
  isApproved         Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([productId, userId]) // One review per product per user
  @@index([productId])
  @@index([userId])
  @@index([rating])
}

// =================================================================
// WISHLIST (Saved for Later)
// =================================================================

model Wishlist {
  id     String @id @default(cuid())
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String @unique // One wishlist per user

  items WishlistItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model WishlistItem {
  id         String   @id @default(cuid())
  wishlist   Wishlist @relation(fields: [wishlistId], references: [id], onDelete: Cascade)
  wishlistId String
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId  String

  note String? // Optional user note

  createdAt DateTime @default(now())

  @@unique([wishlistId, productId]) // Can't add same product twice
  @@index([wishlistId])
  @@index([productId])
}

// =================================================================
// CART & SESSIONS (The "Maybe" Pile)
// =================================================================

model Cart {
  id     String @id @default(cuid())
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String @unique // One cart per user (persistent)

  items CartItem[]

  // For abandoned cart recovery
  lastActivityAt DateTime @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CartItem {
  id        String  @id @default(cuid())
  cart      Cart    @relation(fields: [cartId], references: [id], onDelete: Cascade)
  cartId    String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId String

  quantity Int @default(1)

  // Price at time of adding (for price change notifications)
  priceAtAddInPesewas Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([cartId, productId])
  @@index([cartId])
  @@index([productId])
}

// =================================================================
// ORDERS (The Financial Record)
// =================================================================

enum OrderStatus {
  PENDING // Just created, awaiting payment
  PAYMENT_PENDING // Payment initiated but not confirmed
  CONFIRMED // Payment received, ready for processing
  PROCESSING // Being prepared/packed (by at least one seller)
  PARTIALLY_SHIPPED // Some seller orders shipped
  SHIPPED // All seller orders shipped
  OUT_FOR_DELIVERY
  DELIVERED // All delivered
  CANCELLED // Fully cancelled
  REFUNDED // Fully refunded
  FAILED // Order failed
}

enum SellerOrderStatus {
  PENDING
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

model Order {
  id          String @id @default(cuid())
  orderNumber String @unique // Human-readable: GH-20260205-ABCD

  user   User   @relation(fields: [userId], references: [id])
  userId String

  status OrderStatus @default(PENDING)

  // ===== SNAPSHOT DATA (Immutable after creation) =====

  // Financial Snapshot (Customer Total)
  subtotalInPesewas    Int
  shippingFeeInPesewas Int @default(0)
  taxInPesewas         Int @default(0)
  discountInPesewas    Int @default(0)
  totalInPesewas       Int

  // Shipping Address Snapshot
  shippingFullName      String
  shippingPhone         String
  shippingRegion        String
  shippingCity          String
  shippingArea          String?
  shippingStreetAddress String
  shippingGpsAddress    String?

  // Contact
  customerEmail String
  customerPhone String

  // Relations
  sellerOrders SellerOrder[] // The sub-orders
  items        OrderItem[] // Direct link for easier querying (denormalized)

  // Payment
  payment Payment?

  // Meta
  notes String?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  confirmedAt DateTime?
  cancelledAt DateTime?

  @@index([userId])
  @@index([orderNumber])
  @@index([status])
  @@index([createdAt])
}

// THE SUB-ORDER (Per Seller)
model SellerOrder {
  id String @id @default(cuid())

  // Parent Order
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)
  orderId String

  // The Seller
  seller   SellerProfile @relation(fields: [sellerId], references: [id])
  sellerId String

  // Items
  items OrderItem[]

  // Status
  status SellerOrderStatus @default(PENDING)

  // Financials (Seller's portion)
  subtotalInPesewas     Int
  shippingFeeInPesewas  Int @default(0)
  discountInPesewas     Int @default(0)
  totalInPesewas        Int // (subtotal + shipping - discount)
  platformFeeInPesewas  Int // Commission
  payoutAmountInPesewas Int // (total - commission)

  // Fulfillment
  shippingMethod String?
  trackingNumber String?
  trackingUrl    String?

  shippedAt   DateTime?
  deliveredAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([orderId, sellerId]) // One sub-order per seller per order
  @@index([sellerId])
  @@index([status])
}

model OrderItem {
  id String @id @default(cuid())

  // Links
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)
  orderId String

  sellerOrder   SellerOrder? @relation(fields: [sellerOrderId], references: [id]) // Optional during migration/transition
  sellerOrderId String?

  product   Product @relation(fields: [productId], references: [id])
  productId String

  // ===== SNAPSHOT DATA =====
  productName  String
  productSku   String?
  productImage String?

  quantity            Int
  unitPriceInPesewas  Int
  totalPriceInPesewas Int

  createdAt DateTime @default(now())

  @@index([orderId])
  @@index([sellerOrderId])
  @@index([productId])
}

// =================================================================
// PAYMENTS (The Status)
// =================================================================

enum PaymentMethod {
  MOMO_MTN // MTN Mobile Money
  MOMO_VODAFONE // Vodafone Cash
  MOMO_AIRTELTIGO // AirtelTigo Money
  CARD // Credit/Debit Card
  BANK_TRANSFER // Bank Transfer
  CASH_ON_DELIVERY
}

enum PaymentStatus {
  PENDING // Awaiting payment initiation
  PROCESSING // Payment gateway processing
  SUCCESS // Payment confirmed
  FAILED // Payment failed
  REFUNDED // Fully refunded
  PARTIALLY_REFUNDED
  CANCELLED // Payment cancelled
}

model Payment {
  id      String @id @default(cuid())
  order   Order  @relation(fields: [orderId], references: [id])
  orderId String @unique

  // Amount (in Pesewas)
  amountInPesewas Int

  // Payment Details
  method PaymentMethod
  status PaymentStatus @default(PENDING)

  // ===== GATEWAY REFERENCES (For reconciliation) =====
  // Store the external reference IDs to match with gateway records
  gatewayProvider  String? // "paystack", "hubtel", "flutterwave"
  gatewayReference String? // Their transaction ID
  gatewayResponse  Json? // Full response for debugging

  // Customer payment info (for MoMo)
  momoPhoneNumber String?
  momoNetwork     String? // MTN, Vodafone, AirtelTigo

  // Card info (masked/partial)
  cardLast4 String?
  cardBrand String? // VISA, Mastercard

  // Failure info
  failureReason String?
  failureCode   String?

  // Timestamps
  initiatedAt DateTime  @default(now())
  confirmedAt DateTime?
  failedAt    DateTime?

  // Refunds
  refunds Refund[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orderId])
  @@index([status])
  @@index([gatewayReference])
}

model Refund {
  id        String  @id @default(cuid())
  payment   Payment @relation(fields: [paymentId], references: [id])
  paymentId String

  amountInPesewas Int
  reason          String

  // Gateway info
  gatewayReference String?

  status PaymentStatus @default(PENDING)

  processedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([paymentId])
}

// =================================================================
// AUDIT & SYSTEM
// =================================================================

// For tracking all inventory changes (audit trail)
model InventoryLog {
  id        String @id @default(cuid())
  productId String

  action           String // "SALE", "RESTOCK", "ADJUSTMENT", "RETURN"
  quantityChange   Int // Positive for additions, negative for reductions
  previousQuantity Int
  newQuantity      Int

  // Reference
  orderId String?
  userId  String? // Who made the change
  notes   String?

  createdAt DateTime @default(now())

  @@index([productId])
  @@index([createdAt])
}

// Coupon/Discount codes
model Coupon {
  id   String @id @default(cuid())
  code String @unique

  // Seller (Optional - null means platform-wide)
  seller   SellerProfile? @relation(fields: [sellerId], references: [id])
  sellerId String?

  // Discount
  discountType  String // "percentage" or "fixed"
  discountValue Int // Percentage (10 = 10%) or fixed amount in Pesewas

  // Limits
  minOrderInPesewas    Int?
  maxDiscountInPesewas Int?
  usageLimit           Int?
  usageCount           Int  @default(0)

  // Validity
  startsAt  DateTime  @default(now())
  expiresAt DateTime?
  isActive  Boolean   @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([code])
  @@index([isActive])
}
